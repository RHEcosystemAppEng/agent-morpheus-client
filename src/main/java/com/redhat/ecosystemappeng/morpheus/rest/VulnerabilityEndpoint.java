package com.redhat.ecosystemappeng.morpheus.rest;

import java.util.List;

import com.redhat.ecosystemappeng.morpheus.model.Pagination;
import com.redhat.ecosystemappeng.morpheus.model.SortField;
import com.redhat.ecosystemappeng.morpheus.model.Vulnerability;
import com.redhat.ecosystemappeng.morpheus.model.VulnerabilityFilter;
import com.redhat.ecosystemappeng.morpheus.model.VulnerabilitySort;
import com.redhat.ecosystemappeng.morpheus.service.VulnerabilityService;

import jakarta.inject.Inject;
import jakarta.ws.rs.Consumes;
import jakarta.ws.rs.DELETE;
import jakarta.ws.rs.DefaultValue;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.NotFoundException;
import jakarta.ws.rs.PUT;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.PathParam;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.QueryParam;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;

@Path("/vulnerabilities")
@Consumes(MediaType.APPLICATION_JSON)
public class VulnerabilityEndpoint {

  @Inject
  VulnerabilityService vulnService;

  @GET
  @Path("/{vuln_id}/comments")
  @Produces(MediaType.TEXT_PLAIN)
  public String getComments(@PathParam("vuln_id") String vulnId) {
    var vuln = vulnService.get(vulnId);
    if (vuln == null) {
      throw new NotFoundException("No description found for vulnerability with id: " + vulnId);
    }
    return vuln.comments();
  }

  @PUT
  @Path("/{vuln_id}")
  public Response set(@PathParam("vuln_id") String vulnId, Vulnerability vulnerability) {
    vulnService.set(vulnId, vulnerability);
    return Response.accepted().build();
  }

  @GET
  public Response list(
      @QueryParam("vulnId") String vulnId,
      @QueryParam("sortBy") @DefaultValue("id:ASC") List<String> sortBy,
      @QueryParam("page") @DefaultValue("0") Integer page,
      @QueryParam("pageSize") @DefaultValue("1000") Integer pageSize) {
    var result = vulnService.list(new VulnerabilityFilter(vulnId), new VulnerabilitySort(SortField.fromSortBy(sortBy)),
        new Pagination(page, pageSize));
    return Response.ok(result.results)
        .header("X-Total-Pages", result.totalPages)
        .header("X-Total-Elements", result.totalElements)
        .build();
  }

  @DELETE
  @Path("/{vuln_id}")
  public Response delete(@PathParam("vuln_id") String vulnId) {
    vulnService.delete(vulnId);
    return Response.accepted().build();
  }

  @GET
  @Path("/{vuln_id}")
  public Vulnerability get(@PathParam("vuln_id") String vulnId) {
    var vuln = vulnService.get(vulnId);
    if (vuln == null) {
      throw new NotFoundException("No description found for vulnerability with id: " + vulnId);
    }
    return vuln;
  }
}
