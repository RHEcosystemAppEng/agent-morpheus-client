package com.redhat.ecosystemappeng.morpheus.model;

import java.util.Comparator;
import java.util.List;

public record VulnerabilitySort(List<SortField> fields) {

  private static final String ID = "id";

  private static final List<String> VALID_SORT_FIELDS = List.of(ID);

  public VulnerabilitySort {
    if (fields == null || fields.isEmpty()) {
      fields = List.of(new SortField(ID, SortType.ASC));
    }
    fields.stream().map(SortField::field).forEach(f -> {
      if(!VALID_SORT_FIELDS.contains(f)) {
        throw new IllegalArgumentException("Invalid sortField: " + f);
      }
    });
  }

  private Comparator<Vulnerability> addComparator(Comparator<Vulnerability> base, Comparator<Vulnerability> added) {
    if (base == null) {
      return added;
    }
    return base.thenComparing(added);
  }

  public int compare(Vulnerability a, Vulnerability b) {
    Comparator<Vulnerability> result = null;
    for(var f : fields) {
      Comparator<Vulnerability> fieldComparator = null;
      if (f.field().equals(ID)) {
        if (SortType.ASC.equals(f.type())) {
          fieldComparator = Comparator.comparing(Vulnerability::id, Comparator.nullsLast(Comparator.naturalOrder()));
        } else {
          fieldComparator = Comparator.comparing(Vulnerability::id, Comparator.nullsFirst(Comparator.reverseOrder()));
        }
      }

      result = addComparator(result, fieldComparator);
    };
    if (result == null) {
      return 0;
    }
    return result.compare(a, b);
  }
}
